name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  security:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for exposed secrets
        run: |
          echo "Checking for exposed secrets..."
          if grep -r "password\|secret\|key\|token" --include="*.js" --include="*.json" . | grep -v "node_modules" | grep -v ".git" | grep -v "package-lock.json" | grep -v "test" | grep -iE "(sk-|api_key|private_key|password\s*=)" | head -5; then
            echo "⚠️  Potential secrets found. Please review."
            exit 1
          fi
          echo "✅ No obvious secrets found"

      - name: Validate .env.example exists
        run: |
          if [ ! -f "env-example.txt" ] && [ ! -f ".env.example" ]; then
            echo "⚠️  No .env.example file found"
          else
            echo "✅ .env.example file exists"
          fi

