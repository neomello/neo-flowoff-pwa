name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  security:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for exposed secrets
        run: |
          echo "Checking for exposed secrets..."
          # Procura apenas por secrets hardcoded críticos (valores reais, não referências)
          # Padrões perigosos: sk- seguido de 32+ caracteres (tokens OpenAI reais)
          # Ignora tudo que é referência a variável de ambiente, nome de variável, comentários ou documentação
          SECRETS_FOUND=$(grep -r --include="*.js" --include="*.json" --include="*.ts" \
            -E "(sk-[a-zA-Z0-9]{32,})" \
            . 2>/dev/null | \
            grep -v "node_modules" | \
            grep -v ".git" | \
            grep -v "package-lock.json" | \
            grep -v "test" | \
            grep -v "tests/" | \
            grep -v "\.test\." | \
            grep -v "env-example" | \
            grep -v "\.example\." | \
            grep -v "process\.env" | \
            grep -v "config\." | \
            grep -v "window\.APP_CONFIG" | \
            grep -v "GOOGLE_API_KEY\|OPENAI_API_KEY" | \
            grep -v "VAR_NAME\|VAR\s*=" | \
            grep -v "//.*sk-" | \
            grep -v "/\*.*sk-" | \
            grep -v "\*.*sk-" | \
            grep -v "#.*sk-" | \
            grep -v "example\|Example\|EXAMPLE" | \
            grep -v "placeholder\|Placeholder\|PLACEHOLDER" | \
            grep -v "your.*key\|your.*token\|your.*secret" || true)
          
          if [ -n "$SECRETS_FOUND" ]; then
            echo "⚠️  Potential secrets found. Please review:"
            echo "$SECRETS_FOUND" | head -5
            exit 1
          fi
          echo "✅ No obvious secrets found"

      - name: Validate .env.example exists
        run: |
          if [ ! -f "env-example.txt" ] && [ ! -f ".env.example" ]; then
            echo "⚠️  No .env.example file found"
          else
            echo "✅ .env.example file exists"
          fi

